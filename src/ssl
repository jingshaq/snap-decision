import Foundation
import libcurl

func curlTest() {
    // 初始化libcurl
    let handle = curl_easy_init()
    if handle != nil {
        // 设置URL
        curl_easy_setopt(handle, CURLOPT_URL, "https://www.bing.com")
        // 启用服务器证书验证
        curl_easy_setopt(handle, CURLOPT_SSL_VERIFYPEER, 1L)
        // 启用主机名验证
        curl_easy_setopt(handle, CURLOPT_SSL_VERIFYHOST, 2L)
        
        // 使用iOS系统自带的证书库
        curl_easy_setopt(handle, CURLOPT_SSL_CTX_FUNCTION, { (ctx, param) -> CURLcode in
            let status = SSL_CTX_set_default_verify_paths(ctx)
            return status == 1 ? CURLE_OK : CURLE_SSL_CERTPROBLEM
        })

        // 执行请求
        let res = curl_easy_perform(handle)
        // 检查结果
        if res != CURLE_OK {
            print("curl_easy_perform() failed: \(String(describing: curl_easy_strerror(res)))")
        } else {
            print("Success!")
        }
        // 清理
        curl_easy_cleanup(handle)
    }
}

curlTest()
